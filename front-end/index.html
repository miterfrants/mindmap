<!DOCTYPE>
<html>

<head>
    <title>Testing</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <script src="/mindmap/cytoscape.js"></script>
    <script src="/mindmap/cytoscape-cose-bilkent.js"></script>
    <style>
        html,
        body {
            padding: 0;
            margin: 0;
        }

        body {
            font-family: helvetica;
            font-size: 14px;
        }

        #cy {
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        h1 {
            opacity: 0.5;
            font-size: 1em;
        }

        button {
            margin-right: 10px;
        }

        .hide {
            display: none;
        }

        .btn-layout {
            position: fixed;
            left: 15px;
            top: 15px;
            z-index: 2;
        }

        .node-form {
            position: fixed;
            right: 0;
        }
    </style>
</head>

<body>
    <div class="node-form hide">
        title: <input class="title" type="text" />
        description: <textarea class="description"></textarea>
        <button class="btn-add">add</button>
        <button class="btn-update">update</button>
    </div>

    <div id="cy"></div>
    <button class="btn-layout" type="button">re-arrange</button>

    <script type="module">
        import { API, RESPONSE_STATUS } from '/mindmap/config.js';

        import { apiService, authApiService } from '/mindmap/service/api.js';
        authApiService.init(API, RESPONSE_STATUS);

        import { extendHTMLElementProtoType } from '/mindmap/util/extended-prototype.js';
        extendHTMLElementProtoType();

        import { APP } from '/mindmap/app.js';

        const pathArray = location.pathname.substring(9, location.pathname.length - 1).split('/')
        const moduleName = pathArray[0];
        let cy, isEditMode, boardUniquename, username;

        const reArrange = (e) => {
            var layout = cy.layout({
                name: 'cose-bilkent',
                animate: 'end',
                animationEasing: 'ease-out',
                animationDuration: 1000,
                randomize: true
            });
            layout.run();
        }
        const saveNode = async (e) => {
            const title = document.querySelector('.title').value;
            const description = document.querySelector('.description').value;
            const token = localStorage.getItem('token');

            cy.trigger('createNode', [
                title,
                description
            ]);

            const resp = await authApiService.nodes.post({
                title,
                description,
                token,
                username,
                selectedBoard: {
                    uniquename: boardUniquename
                }
            });

            if (resp.status === RESPONSE_STATUS.OK) {
                cy.trigger('saveNodeDone', [
                    resp.data
                ]);
                document.querySelector('.title').value = '';
                document.querySelector('.description').value = '';
            }
        }
        const openNodeWindow = (e) => {
            const title = e.detail.title;
            const desc = e.detail.description;
            const w = 400;
            const dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : window.screenX;
            const dualScreenTop = window.screenTop != undefined ? window.screenTop : window.screenY;

            const width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
            const height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

            const systemZoom = width / window.screen.availWidth;
            const left = (width - w) / 2 / systemZoom + dualScreenLeft
            const top = 0
            const newWindow = window.open('', title, 'id=popup-mindmap, scrollbars=yes, width=' + w / systemZoom + ', height=' + height / systemZoom + ', top=' + top + ', left=' + left);
            const template = "<h1>{title}</h1><p>{desc}</p>"
            const result = template.replace(/{title}/gi, title)
                .replace(/{desc}/gi, desc);
            newWindow.document.querySelector("body").innerHTML = result;
            newWindow.document.querySelector("head").innerHTML = "<title>" + title + "</title>"

            // Puts focus on the newWindow
            if (window.focus) newWindow.focus();
        }
        const saveEdge = async (e) => {
            const token = localStorage.getItem('token');
            const resp = await authApiService.relationship.post({
                parent_node_id: e.detail.parent_node_id,
                child_node_id: e.detail.child_node_id,
                token,
                username,
                boardUniquename
            });

            if (resp.status === RESPONSE_STATUS.OK) {
                cy.trigger('saveEdgeDone', [
                    {
                        ...resp.data,
                        edgeInstance: e.detail.edgeInstance
                    }
                ]);
            }
        }

        document.querySelector('.btn-add').addEventListener('click', saveNode);
        document.querySelector('.btn-layout').addEventListener('click', reArrange);
        document.addEventListener('double-tap-node', openNodeWindow);
        document.addEventListener('save-edge', saveEdge);

        (async () => {
            let nodes, relationship;
            if (moduleName === 'boards') {
                boardUniquename = pathArray[1];
                nodes = (await apiService.nodes.get({
                    boardUniquename
                })).data;
                relationship = (await apiService.relationship.get({
                    boardUniquename
                })).data;
            } else if (moduleName === 'users') {
                username = pathArray[1];
                boardUniquename = pathArray[3];
                const token = localStorage.getItem('token');
                isEditMode = true;
                nodes = (await authApiService.nodes.get({
                    username,
                    boardUniquename,
                    token
                })).data
                relationship = (await authApiService.relationship.get({
                    username,
                    boardUniquename,
                    token
                })).data;

                // hide node form;
                document.querySelector('.node-form').removeClass('hide');
            }
            const container = document.getElementById('cy');
            cy = APP.init(container, nodes, relationship, isEditMode);
        })();
    </script>
</body>

</html>