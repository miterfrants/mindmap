<!DOCTYPE>
<html>

<head>
    <title>Testing</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script src="/mindmap/cytoscape-cose-bilkent.js"></script>
    <style>
        body {
            font-family: helvetica;
            font-size: 14px;
        }

        #cy {
            width: 100%;
            height: 90%;
            z-index: 999;
        }

        h1 {
            opacity: 0.5;
            font-size: 1em;
        }

        button {
            margin-right: 10px;
        }

        .hide {
            display: none;
        }
    </style>
    <script type="module">
        import { apiService, authApiService } from '/mindmap/service/api.js';
        import { API, RESPONSE_STATUS } from '/mindmap/config.js';
        authApiService.init(API, RESPONSE_STATUS);
        const pathArray = location.pathname.substring(9, location.pathname.length - 1).split('/')
        const moduleName = pathArray[0];
        let x, y, currentNode, isCreateing, cy;

        (async () => {
            let nodes, relationship;
            if (moduleName === 'boards') {
                const boardUniquename = pathArray[1];
                nodes = (await apiService.nodes.get({
                    boardUniquename
                })).data;
                relationship = (await apiService.relationship.get({
                    boardUniquename
                })).data;
            } else if (moduleName === 'users') {
                const username = pathArray[1];
                const boardUniquename = pathArray[3];
                const token = localStorage.getItem('token');
                nodes = (await authApiService.nodes.get({
                    username,
                    boardUniquename,
                    token
                })).data;
                relationship = (await authApiService.relationship.get({
                    username,
                    boardUniquename,
                    token
                })).data;
            }
            const elements = DATA.prepareData(nodes, relationship);
            const container = document.getElementById('cy');
            cy = APP.init(container, elements);
        })();

        const APP = {
            init: (container, elements) => {
                const cy = cytoscape({
                    container: container,
                    layout: {
                        name: 'cose-bilkent',
                        animate: false,
                        randomize: true
                    },

                    style: [{
                        selector: 'node',
                        style: {
                            'background-color': 'data(background)',
                            'label': 'data(title)',
                            "font-size": "10px",
                            "height": 'data(size)',
                            "width": 'data(size)',
                        }
                    }, {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#4ba6d8'
                        }
                    }],
                    elements
                })
                cy.on('tap', function (event) {
                    if (event.target === cy) {
                        if (!isCreateing) {
                            currentNode = null;
                            x = event.position.x;
                            y = event.position.y;
                            document.querySelector('.title').focus();
                            document.querySelector('.btn-add').innerHTML = 'add';
                        }
                    } else {
                        currentNode = event.target;
                        const data = event.target.data();
                        document.querySelector('.title').value = data.title
                        document.querySelector('.description').value = data.description
                        document.querySelector('.btn-add').innerHTML = 'update';
                    }
                });
                return cy;
            }
        }

        const UI = {
            add: (x, y, title, desc) => {
                if (currentNode) {
                    currentNode.data({
                        title,
                        description: desc
                    })
                } else {
                    isCreateing = true;
                    const nodes = cy.add([{
                        data: {
                            id: 'create',
                            title: title,
                            description: desc,
                            background: '#eeb349',
                            size: 50
                        },
                        position: {
                            x,
                            y
                        },
                        group: "nodes",
                        grabbable: true,
                    }]);
                    controller.node.post({
                        title: nodes[0].data().title,
                        description: nodes[0].data().description
                    }, (resp) => {
                        console.log(resp);
                        // UI.afterPostNode(nodes[0]);
                    })
                }
            }
        }

        const DATA = {
            prepareData: (nodes, relationship) => {
                const elements = [];
                for (let i = 0; i < nodes.length; i++) {
                    const style = DATA.getStyle(nodes[i].description);
                    elements.push({
                        data: {
                            id: nodes[i].id,
                            title: nodes[i].title,
                            description: nodes[i].description,
                            background: style.background,
                            size: style.size
                        },
                        group: "nodes",
                        grabbable: true,
                    });
                }

                for (let i = 0; i < relationship.length; i++) {
                    elements.push({
                        data: {
                            id: relationship[i].id,
                            source: relationship[i].parent_node_id,
                            target: relationship[i].child_node_id,
                        },
                        group: "edges",
                        grabbable: true
                    })
                }

                return elements;
            },
            getStyle: (description) => {
                const length = description.length;
                if (length > 0 && length <= 60) {
                    return {
                        background: '#3897f0',
                        size: 50
                    }
                } else if (length > 60 && length <= 360) {
                    return {
                        background: '#57aeff',
                        size: 70
                    }
                } else if (length > 360 && length <= 1200) {
                    return {
                        background: '#88c6ff',
                        size: 90
                    }
                } else if (length > 1200 && length <= 4000) {
                    return {
                        background: '#a8d3fb',
                        size: 110
                    }
                } else if (length > 4000) {
                    return {
                        background: '#d1e9ff',
                        size: 130
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelector('.btn-add').addEventListener('click', (e) => {
                const title = document.querySelector('.title').value;
                const description = document.querySelector('.description').value;
                UI.add(x, y, title, description);
            })
            document.getElementById("layoutButton").addEventListener("click", function () {
                var layout = cy.layout({
                    name: 'cose-bilkent',
                    animate: 'end',
                    animationEasing: 'ease-out',
                    animationDuration: 1000,
                    randomize: true
                });

                layout.run();
            });
            document.getElementById("randomize").addEventListener("click", function () {
                var layout = cy.layout({
                    name: 'random',
                    animate: true,
                    animationDuration: 1000,
                    animationEasing: 'ease-out'
                });

                layout.run();
            });
        });
    </script>
</head>

<body>
    <div class="node-form">
        title: <input class="title" type="text" />
        description: <textarea class="description"></textarea>
        <button class="btn-add">add</button>
    </div>
    <h1>cytoscape-cose-bilkent demo</h1>

    <button id="randomize" type="button">Randomize</button>
    <button id="layoutButton" type="button">CoSE-Bilkent</button>

    <div id="cy"></div>

</body>

</html>